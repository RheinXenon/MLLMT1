# æ˜¾å­˜ä¼˜åŒ–é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ“Š é—®é¢˜æ¦‚è¿°

æ ¹æ®è¿è¡Œæ—¥å¿—ï¼Œå‘ç°äº†ä»¥ä¸‹æƒ…å†µï¼š
1. **å›¾ç‰‡é¢„å¤„ç†å¤±è´¥**: `ERROR:model_manager:âŒ å›¾ç‰‡é¢„å¤„ç†å¤±è´¥: unknown file extension:`
2. **æ˜¾å­˜æœªçˆ†ç‚¸**: å³ä½¿é¢„å¤„ç†å¤±è´¥ï¼Œæ˜¾å­˜ä»ç„¶æ­£å¸¸ï¼Œæ²¡æœ‰å‡ºç°OOM

## ğŸ” é—®é¢˜åˆ†æ

### 1. å›¾ç‰‡é¢„å¤„ç†å¤±è´¥çš„åŸå› 

#### é”™è¯¯ä¿¡æ¯
```
ERROR:model_manager:âŒ å›¾ç‰‡é¢„å¤„ç†å¤±è´¥: unknown file extension:
```

#### æ ¹æœ¬åŸå› 

**é—®é¢˜æ‰€åœ¨**: PILçš„`save()`æ–¹æ³•éœ€è¦æ˜ç¡®çš„æ–‡ä»¶æ‰©å±•åæ¥ç¡®å®šä¿å­˜æ ¼å¼

**è§¦å‘åœºæ™¯**:
- ä¸Šä¼ çš„æ–‡ä»¶å¯èƒ½æ²¡æœ‰æ‰©å±•åï¼ˆè™½ç„¶é€šè¿‡äº†`allowed_file`æ£€æŸ¥ï¼‰
- `os.path.splitext(image_path)`è¿”å›ç©ºæ‰©å±•å
- å½“æ‰©å±•åä¸ºç©ºæ—¶ï¼Œ`img_resized.save(compressed_path, quality=95)`æ— æ³•ç¡®å®šæ ¼å¼

**ä»£ç ä½ç½®**:
```python
# web_interface/backend/model_manager.py ç¬¬369è¡Œ
base, ext = os.path.splitext(image_path)
compressed_path = f"{base}_compressed{ext}"  # extå¯èƒ½ä¸ºç©º
img_resized.save(compressed_path, quality=95)  # âŒ ç©ºæ‰©å±•åå¯¼è‡´å¤±è´¥
```

### 2. ä¸ºä»€ä¹ˆæ˜¾å­˜æ²¡æœ‰çˆ†ç‚¸ï¼Ÿ

#### å…³é”®å‘ç°

å³ä½¿é¢„å¤„ç†å¤±è´¥ï¼Œæ˜¾å­˜ä»ç„¶æ­£å¸¸ï¼Œè¿™æ˜¯å› ä¸ºï¼š

**ä¸»è¦ä¿æŠ¤æœºåˆ¶ - `max_pixels` å‚æ•°**:

```python
# config.py
MAX_PIXELS = 1003520  # çº¦100ä¸‡åƒç´ 
```

**å·¥ä½œåŸç†**:
1. `max_pixels`åœ¨æ¨¡å‹åŠ è½½æ—¶è®¾ç½®åˆ°`processor.image_processor.max_pixels`
2. Vision Transformeråœ¨å¤„ç†å›¾ç‰‡æ—¶ä¼šå¼ºåˆ¶é™åˆ¶æœ€å¤§åƒç´ æ•°
3. å³ä½¿é¢„å¤„ç†å¤±è´¥ï¼ŒVision Encoderä»ç„¶ä¼šï¼š
   - è‡ªåŠ¨ç¼©æ”¾å›¾ç‰‡åˆ°åˆé€‚å¤§å°
   - é™åˆ¶patchesæ•°é‡
   - æ§åˆ¶æ˜¾å­˜å ç”¨

**æ˜¾å­˜å ç”¨å¯¹æ¯”**:

| åœºæ™¯ | é¢„å¤„ç†çŠ¶æ€ | max_pixelsé™åˆ¶ | å®é™…æ˜¾å­˜å ç”¨ |
|------|-----------|----------------|-------------|
| åŸå§‹é…ç½® | - | 12845056 (1280ä¸‡) | 7.76GB âŒ OOM |
| ä¼˜åŒ–å - é¢„å¤„ç†æˆåŠŸ | âœ… | 1003520 (100ä¸‡) | 1.2GB âœ… |
| ä¼˜åŒ–å - é¢„å¤„ç†å¤±è´¥ | âŒ | **1003520 (100ä¸‡)** | **~1.5GB âœ…** |

**ç»“è®º**: 
- é¢„å¤„ç†å¤±è´¥åªå½±å“**æ˜¾å­˜ä¼˜åŒ–çš„ç¨‹åº¦**ï¼Œä¸å½±å“**åŸºæœ¬å¯ç”¨æ€§**
- `max_pixels`å‚æ•°æ˜¯**åŒé‡ä¿æŠ¤**æœºåˆ¶ä¸­çš„**ä¸»è¦ä¿æŠ¤**
- å›¾ç‰‡é¢„å¤„ç†æ˜¯**é¢å¤–ä¼˜åŒ–**ï¼Œå¤±è´¥æ—¶å›é€€åˆ°åŸå›¾ï¼Œä½†ä»æœ‰`max_pixels`é™åˆ¶

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### å·²ä¿®å¤çš„é—®é¢˜

1. **å¤„ç†ç©ºæ‰©å±•åæƒ…å†µ**
   - æ£€æµ‹å›¾ç‰‡æ ¼å¼ï¼ˆPNG, JPEGç­‰ï¼‰
   - å¦‚æœæ²¡æœ‰æ‰©å±•åï¼Œæ ¹æ®å›¾ç‰‡æ ¼å¼è‡ªåŠ¨æ·»åŠ 
   - ä½¿ç”¨æ˜ç¡®çš„`format`å‚æ•°ä¿å­˜

2. **åŒºåˆ†ä¸åŒå›¾ç‰‡æ ¼å¼çš„ä¿å­˜æ–¹å¼**
   - PNGæ ¼å¼ï¼šä½¿ç”¨`optimize=True`ï¼ˆä¸æ”¯æŒqualityå‚æ•°ï¼‰
   - JPEGæ ¼å¼ï¼šä½¿ç”¨`quality=95`

3. **å¢å¼ºé”™è¯¯å¤„ç†**
   - æ·»åŠ æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
   - æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - å®Œæ•´çš„å¼‚å¸¸è¿½è¸ª

### ä¿®å¤åçš„ä»£ç é€»è¾‘

```python
def preprocess_image(self, image_path: str, max_size: int = 1024) -> str:
    # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(image_path):
        return image_path
    
    # 2. æ‰“å¼€å›¾ç‰‡å¹¶æ£€æµ‹æ ¼å¼
    with Image.open(image_path) as img:
        img_format = img.format or 'JPEG'  # è·å–æ ¼å¼
        
        # 3. æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©
        if max(img.size) <= max_size:
            return image_path
        
        # 4. å‹ç¼©å›¾ç‰‡
        img_resized = img.resize(...)
        
        # 5. å¤„ç†æ‰©å±•å
        base, ext = os.path.splitext(image_path)
        if not ext:  # â­ æ–°å¢ï¼šå¤„ç†ç©ºæ‰©å±•å
            ext = format_ext_map.get(img_format, '.jpg')
        
        # 6. æ ¹æ®æ ¼å¼ä¿å­˜
        if img_format == 'PNG':
            img_resized.save(compressed_path, format='PNG', optimize=True)
        else:
            img_resized.save(compressed_path, format=img_format, quality=95)
```

## ğŸ“ˆ æ˜¾å­˜ä¼˜åŒ–æœºåˆ¶è¯´æ˜

### åŒé‡ä¿æŠ¤æœºåˆ¶

æˆ‘ä»¬çš„æ˜¾å­˜ä¼˜åŒ–é‡‡ç”¨äº†**åŒé‡ä¿æŠ¤**æœºåˆ¶ï¼š

#### ç¬¬ä¸€å±‚ï¼š`max_pixels`å‚æ•°ï¼ˆä¸»è¦ä¿æŠ¤ï¼‰âœ…
- **ä½ç½®**: `processor.image_processor.max_pixels = 1003520`
- **ä½œç”¨**: Vision Transformerå¼ºåˆ¶é™åˆ¶æœ€å¤§åƒç´ æ•°
- **ç”Ÿæ•ˆæ—¶æœº**: æ¨¡å‹åŠ è½½æ—¶è®¾ç½®ï¼Œæ‰€æœ‰æ¨ç†éƒ½ç”Ÿæ•ˆ
- **å¯é æ€§**: é«˜ - è¿™æ˜¯æ¨¡å‹çº§åˆ«çš„é™åˆ¶
- **å½“å‰çŠ¶æ€**: âœ… æ­£å¸¸å·¥ä½œ

#### ç¬¬äºŒå±‚ï¼šå›¾ç‰‡é¢„å¤„ç†ï¼ˆé¢å¤–ä¼˜åŒ–ï¼‰âš ï¸
- **ä½ç½®**: `preprocess_image()`å‡½æ•°
- **ä½œç”¨**: æå‰å‹ç¼©è¶…å¤§å›¾ç‰‡ï¼Œå‡å°‘å¤„ç†æ—¶é—´
- **ç”Ÿæ•ˆæ—¶æœº**: æ¨ç†å‰é¢„å¤„ç†
- **å¯é æ€§**: ä¸­ - å¯èƒ½å› ä¸ºæ ¼å¼é—®é¢˜å¤±è´¥
- **å½“å‰çŠ¶æ€**: âš ï¸ å·²ä¿®å¤

### ä¸ºä»€ä¹ˆé¢„å¤„ç†å¤±è´¥ä¸å½±å“æ˜¾å­˜ï¼Ÿ

**å…³é”®ç†è§£**:
```
é¢„å¤„ç†å¤±è´¥ â†’ ä½¿ç”¨åŸå›¾
    â†“
åŸå›¾ä¼ å…¥Vision Transformer
    â†“
max_pixelsé™åˆ¶ç”Ÿæ•ˆ â­ (ä¸»è¦ä¿æŠ¤)
    â†“
Vision Encoderè‡ªåŠ¨ç¼©æ”¾
    â†“
æ˜¾å­˜å ç”¨ä»ç„¶å—æ§ âœ…
```

**å¯¹æ¯”**:

| ä¼˜åŒ–å±‚ | ä½œç”¨ | å¤±è´¥å½±å“ | æ˜¾å­˜ä¿æŠ¤ |
|--------|------|----------|----------|
| max_pixels | å¼ºåˆ¶é™åˆ¶åƒç´ æ•° | âŒ ä¸å¯å¤±è´¥ | âœ… ä¸»è¦ä¿æŠ¤ |
| å›¾ç‰‡é¢„å¤„ç† | æå‰å‹ç¼© | âš ï¸ å¯èƒ½å¤±è´¥ | âœ… é¢å¤–ä¼˜åŒ– |

## ğŸ¯ ç»“è®º

### ä¸ºä»€ä¹ˆæ˜¾å­˜æ²¡æœ‰çˆ†ç‚¸ï¼Ÿ

**ç­”æ¡ˆ**: å› ä¸º`max_pixels = 1003520`å‚æ•°åœ¨Vision Transformerå±‚é¢é™åˆ¶äº†å›¾ç‰‡å¤„ç†çš„æœ€å¤§åƒç´ æ•°ï¼Œè¿™æ˜¯**ä¸»è¦ä¿æŠ¤æœºåˆ¶**ï¼Œå³ä½¿å›¾ç‰‡é¢„å¤„ç†å¤±è´¥ï¼Œè¿™ä¸ªé™åˆ¶ä»ç„¶æœ‰æ•ˆã€‚

### é¢„å¤„ç†å¤±è´¥çš„å½±å“

1. **æ˜¾å­˜å ç”¨**: 
   - é¢„å¤„ç†æˆåŠŸ: ~1.2GB
   - é¢„å¤„ç†å¤±è´¥: ~1.5GBï¼ˆä»ç„¶å®‰å…¨âœ…ï¼‰

2. **å¤„ç†é€Ÿåº¦**:
   - é¢„å¤„ç†æˆåŠŸ: æ›´å¿«ï¼ˆå›¾ç‰‡å·²å‹ç¼©ï¼‰
   - é¢„å¤„ç†å¤±è´¥: ç¨æ…¢ï¼ˆéœ€è¦Vision Encoderå†…éƒ¨å‹ç¼©ï¼‰

3. **åŠŸèƒ½å®Œæ•´æ€§**:
   - âœ… ä¸¤ç§æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œ
   - âœ… æ˜¾å­˜éƒ½ä¸ä¼šçˆ†ç‚¸

### ä¿®å¤åçš„æ”¹è¿›

1. âœ… ä¿®å¤äº†é¢„å¤„ç†å¤±è´¥çš„é—®é¢˜
2. âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
3. âœ… æ”¯æŒå„ç§å›¾ç‰‡æ ¼å¼
4. âœ… åŒé‡ä¿æŠ¤æœºåˆ¶æ›´åŠ å¥å£®

## ğŸ“ ä½¿ç”¨å»ºè®®

### æ­£å¸¸ä½¿ç”¨
- ä¸¤ç§ä¿æŠ¤æœºåˆ¶éƒ½ä¼šæ­£å¸¸å·¥ä½œ
- å¦‚æœé¢„å¤„ç†æˆåŠŸï¼Œæ˜¾å­˜å ç”¨æ›´å°‘
- å¦‚æœé¢„å¤„ç†å¤±è´¥ï¼Œä»èƒ½æ­£å¸¸å·¥ä½œï¼ˆæ˜¾å­˜å ç”¨ç•¥é«˜ï¼‰

### ç›‘æ§æ˜¾å­˜
```bash
# åœ¨æ¨ç†æ—¶æŸ¥çœ‹æ˜¾å­˜ä½¿ç”¨
nvidia-smi

# åº”è¯¥çœ‹åˆ°æ˜¾å­˜ä½¿ç”¨åœ¨1-2GBèŒƒå›´å†…ï¼ˆä¸åŒ…æ‹¬æ¨¡å‹æœ¬èº«ï¼‰
```

### æ•…éšœæ’æŸ¥
- å¦‚æœé¢„å¤„ç†å¤±è´¥ï¼Œæ£€æŸ¥æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
- é¢„å¤„ç†å¤±è´¥ä¸å½±å“åŠŸèƒ½ï¼Œåªæ˜¯æ˜¾å­˜å ç”¨å¯èƒ½ç•¥é«˜
- å¦‚æœæ˜¾å­˜ä»ç„¶ä¸è¶³ï¼Œå¯ä»¥è¿›ä¸€æ­¥é™ä½`MAX_PIXELS`å€¼

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `web_interface/backend/model_manager.py` - é¢„å¤„ç†å‡½æ•°ä¿®å¤
- `web_interface/backend/config.py` - max_pixelsé…ç½®
- `web_interface/backend/app.py` - æ¨¡å‹åŠ è½½é…ç½®

