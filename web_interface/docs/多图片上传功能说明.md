# 多图片上传功能说明

## 功能概述

系统现已支持一次上传和分析多张图片（最多5张），适用于需要对比分析多张医学影像的场景。

## 主要特性

1. **多图片选择**：支持一次性选择多张图片（Ctrl/Cmd + 点击）
2. **实时预览**：显示所有已选图片的缩略图预览
3. **独立管理**：每张图片可以单独删除
4. **批量上传**：所有选中的图片会一起发送给AI模型分析
5. **数量限制**：最多支持5张图片同时上传

## 使用方法

### 1. 选择多张图片
- 点击输入框左侧的"📎"按钮
- 在文件选择对话框中，按住Ctrl(Windows)或Cmd(Mac)键选择多张图片
- 或者拖动选择多张图片

### 2. 管理已选图片
- 选中的图片会显示在输入框上方的预览区域
- 每张图片右上角有"✕"按钮，点击可单独移除
- 预览区域显示已选图片数量

### 3. 发送分析
- 输入问题描述
- 点击"发送"按钮
- AI会同时分析所有上传的图片

## 关键优化：多图片提示词增强

### 问题发现
在初始实现中，虽然系统可以上传多张图片，但模型返回的结果往往只针对第一张图片，没有综合分析所有图片。

### 解决方案
系统会自动检测上传的图片数量，当检测到多张图片（2张或以上）时，会自动增强用户的提示词：

**原始提示词：**
```
请分析这些X光片的异常情况
```

**自动增强后：**
```
我上传了3张图片。请分析这些X光片的异常情况

请仔细分析每一张图片，对比它们之间的差异和联系，并给出综合的分析结果。
```

这样可以确保模型：
1. 意识到有多张图片需要分析
2. 对每张图片都进行仔细分析
3. 进行图片之间的对比
4. 给出综合的分析结果

### 用户建议
为了获得更好的多图片分析效果，建议在提示词中：
- 明确说明希望对比分析的方面
- 指出需要特别关注的区域
- 说明图片之间的关系（如时间序列、不同角度等）

**示例提示词：**
- "对比这三张不同时期的CT扫描，分析病灶的变化趋势"
- "分析这两张不同角度的X光片，判断骨折的位置和严重程度"
- "比较这几张超声图像，评估治疗前后的效果"

## 技术实现

### 前端修改

#### HTML (index.html)
- 添加`multiple`属性支持多文件选择
- 改用`image-preview-container`和`image-preview-list`容器显示多图片

#### CSS (style.css)
- 新增`.image-preview-container`：多图片预览容器样式
- 新增`.image-preview-list`：横向排列的图片列表
- 新增`.image-preview-item`：单个图片预览项
- 新增`.message-images`：消息中显示多图片的布局

#### JavaScript (main.js, api.js)
- `appState.currentImages`：改为数组存储多张图片
- `handleImageSelect()`：处理多文件选择和验证
- `updateImagePreview()`：动态更新预览显示
- `handleRemoveSingleImage()`：移除单张图片
- `handleRemoveAllImages()`：清空所有图片
- `addMessageToDOM()`：支持显示多张图片
- `apiClient.chatStream()`：支持发送图片数组

### 后端修改

#### API (app.py)
- `/api/chat`和`/api/chat_stream`端点：
  - 使用`request.files.getlist('images')`接收多张图片
  - 为每张图片添加时间戳避免文件名冲突
  - 保存多个临时文件并传递给模型管理器
  - 处理完成后清理所有临时文件

#### 模型管理器 (model_manager.py)
- `generate_response_with_history()`：
  - 参数改为`image_paths: List[str]`
  - 支持在消息内容中添加多张图片
  - 使用`process_vision_info()`处理多图片输入
  
- `generate_response_stream()`：
  - 同样支持`image_paths`参数
  - 流式输出时处理多张图片

## 限制与注意事项

1. **数量限制**：最多支持5张图片，超出会提示错误
2. **文件大小**：每张图片最大16MB
3. **文件格式**：支持常见图片格式（jpg, jpeg, png, gif, webp等）
4. **内存占用**：多图片会增加GPU/内存占用，请根据硬件配置调整

## 向后兼容

代码保持向后兼容，仍支持单张图片的使用方式：
- 前端可以传递单个File对象或File数组
- 后端会自动处理单图片或多图片场景
- 历史对话中的旧消息格式仍可正常加载

## 更新日期

2025年11月2日

