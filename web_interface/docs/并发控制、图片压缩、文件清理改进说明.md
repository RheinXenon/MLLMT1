# å¤„ç†åŠŸèƒ½ä¼˜åŒ–è¯´æ˜

æœ¬æ–‡æ¡£è®°å½•äº†é’ˆå¯¹å¤šå›¾ç‰‡å¤„ç†åŠŸèƒ½çš„ä¸‰é¡¹æ ¸å¿ƒæ”¹è¿›ï¼ˆå¹¶å‘æ§åˆ¶ã€å›¾ç‰‡å‹ç¼©ã€æ–‡ä»¶æ¸…ç†ï¼‰ã€‚

## æ”¹è¿›æ—¥æœŸ

2025å¹´11æœˆ3æ—¥

---

## æ”¹è¿›1ï¼šæ·»åŠ å¹¶å‘æ§åˆ¶æœºåˆ¶ âœ…

### é—®é¢˜

- å¤šä¸ªç”¨æˆ·åŒæ—¶ä¸Šä¼ å¤šå¼ å¤§å›¾å¯èƒ½å¯¼è‡´æœåŠ¡å™¨OOM
- ç¼ºå°‘è¯·æ±‚é˜Ÿåˆ—æˆ–é™æµæœºåˆ¶

### è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨**ä¿¡å·é‡(Semaphore)**å®ç°å¹¶å‘æ§åˆ¶ï¼š

#### é…ç½®æ–‡ä»¶ (config.py)

```python
# å¹¶å‘æ§åˆ¶é…ç½®
MAX_CONCURRENT_REQUESTS = 3  # æœ€å¤§å¹¶å‘è¯·æ±‚æ•°ï¼ˆé˜²æ­¢æœåŠ¡å™¨è¿‡è½½ï¼‰
REQUEST_TIMEOUT = 300  # è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
```

#### åç«¯å®ç° (app.py)

1. **åˆ›å»ºå…¨å±€ä¿¡å·é‡**ï¼š

```python
from threading import Semaphore
request_semaphore = Semaphore(config.MAX_CONCURRENT_REQUESTS)
```

2. **è£…é¥°å™¨æ–¹å¼**ï¼ˆç”¨äºéæµå¼æ¥å£ï¼‰ï¼š

```python
def with_concurrency_limit(f):
    """è£…é¥°å™¨ï¼šé™åˆ¶å¹¶å‘è¯·æ±‚æ•°"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not request_semaphore.acquire(blocking=False):
            return jsonify({"error": "æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"}), 429
        try:
            return f(*args, **kwargs)
        finally:
            request_semaphore.release()
    return decorated_function

@app.route('/api/chat', methods=['POST'])
@with_concurrency_limit  # åº”ç”¨è£…é¥°å™¨
def chat():
    # ... å¤„ç†é€»è¾‘
```

3. **æ‰‹åŠ¨æ§åˆ¶æ–¹å¼**ï¼ˆç”¨äºæµå¼æ¥å£ï¼‰ï¼š

```python
@app.route('/api/chat_stream', methods=['POST'])
def chat_stream():
    # è·å–ä¿¡å·é‡
    if not request_semaphore.acquire(blocking=False):
        return error_response("æœåŠ¡å™¨ç¹å¿™")
  
    def generate():
        try:
            # ... ç”Ÿæˆé€»è¾‘
        finally:
            request_semaphore.release()  # åœ¨finallyä¸­é‡Šæ”¾
```

### æ•ˆæœ

- âœ… é™åˆ¶æœ€å¤§å¹¶å‘æ•°ä¸º3ä¸ªè¯·æ±‚
- âœ… è¶…å‡ºé™åˆ¶æ—¶è¿”å›429çŠ¶æ€ç ï¼ˆToo Many Requestsï¼‰
- âœ… é˜²æ­¢æœåŠ¡å™¨è¿‡è½½å’ŒOOM

---

## æ”¹è¿›2ï¼šç»Ÿä¸€å›¾ç‰‡å‹ç¼©é€»è¾‘ âœ…

### é—®é¢˜

- å›¾ç‰‡å‹ç¼©é€»è¾‘ä¸ç»Ÿä¸€
- éæµå¼æ¥å£æ²¡æœ‰è°ƒç”¨å›¾ç‰‡å‹ç¼©
- ä»£ç é‡å¤

### è§£å†³æ–¹æ¡ˆ

åœ¨æ¨¡å‹ç®¡ç†å™¨çš„å“åº”ç”Ÿæˆæ–¹æ³•ä¸­**ç»Ÿä¸€é¢„å¤„ç†å›¾ç‰‡**ï¼š

#### æ¨¡å‹ç®¡ç†å™¨ (model_manager.py)

**éæµå¼è¾“å‡º**ï¼š

```python
def generate_response_with_history(self, prompt, image_paths=None, ...):
    # è®°å½•å‹ç¼©åçš„å›¾ç‰‡è·¯å¾„
    compressed_paths = []
  
    try:
        # ç»Ÿä¸€é¢„å¤„ç†å›¾ç‰‡ï¼ˆå‹ç¼©ä»¥èŠ‚çœæ˜¾å­˜ï¼‰
        if image_paths and len(image_paths) > 0:
            logger.info("ğŸ–¼ï¸ å¼€å§‹é¢„å¤„ç†å›¾ç‰‡...")
            processed_paths = []
            for img_path in image_paths:
                processed_path = self.preprocess_image(img_path, max_size=1024)
                processed_paths.append(processed_path)
                # å¦‚æœç”Ÿæˆäº†å‹ç¼©æ–‡ä»¶ï¼Œè®°å½•ä¸‹æ¥
                if processed_path != img_path:
                    compressed_paths.append(processed_path)
            image_paths = processed_paths
      
        # æ¸…ç†CUDAç¼“å­˜
        self.clear_cuda_cache()
      
        # ... ç”Ÿæˆé€»è¾‘ ...
      
        return {
            "success": True,
            "response": response,
            "compressed_paths": compressed_paths  # è¿”å›å‹ç¼©æ–‡ä»¶è·¯å¾„
        }
```

**æµå¼è¾“å‡º**ï¼š

```python
def generate_response_stream(self, prompt, image_paths=None, ..., 
                            compressed_paths_container=None):
    """
    compressed_paths_container: ç”¨äºè¿”å›å‹ç¼©æ–‡ä»¶è·¯å¾„çš„åˆ—è¡¨å®¹å™¨
    """
    try:
        # ç»Ÿä¸€é¢„å¤„ç†å›¾ç‰‡
        if image_paths and len(image_paths) > 0:
            processed_paths = []
            for img_path in image_paths:
                processed_path = self.preprocess_image(img_path, max_size=1024)
                processed_paths.append(processed_path)
                # è®°å½•åˆ°å®¹å™¨
                if processed_path != img_path and compressed_paths_container is not None:
                    compressed_paths_container.append(processed_path)
            image_paths = processed_paths
      
        # ... æµå¼ç”Ÿæˆé€»è¾‘ ...
```

### æ•ˆæœ

- âœ… æ‰€æœ‰è·¯å¾„éƒ½ç»Ÿä¸€å‹ç¼©å›¾ç‰‡
- âœ… æ¶ˆé™¤ä»£ç é‡å¤
- âœ… èŠ‚çœæ˜¾å­˜å ç”¨
- âœ… å‹ç¼©æ–‡ä»¶è·¯å¾„å¯è¿½è¸ª

---

## æ”¹è¿›3ï¼šæ¸…ç†å‹ç¼©åçš„ä¸´æ—¶æ–‡ä»¶ âœ…

### é—®é¢˜

- å‹ç¼©åçš„ä¸´æ—¶æ–‡ä»¶ï¼ˆ`*_compressed.*`ï¼‰æ²¡æœ‰è¢«æ¸…ç†
- uploadsç›®å½•ç§¯ç´¯å¤§é‡ä¸´æ—¶æ–‡ä»¶
- å¯èƒ½å¯¼è‡´ç£ç›˜ç©ºé—´ä¸è¶³

### è§£å†³æ–¹æ¡ˆ

æ‰©å±•æ¸…ç†é€»è¾‘ï¼Œæ¸…ç†**åŸå§‹æ–‡ä»¶å’Œå‹ç¼©æ–‡ä»¶**ï¼š

#### åç«¯å®ç° (app.py)

**éæµå¼æ¥å£**ï¼š

```python
@app.route('/api/chat', methods=['POST'])
def chat():
    # ... ç”Ÿæˆå›å¤ ...
    result = model_manager.generate_response_with_history(...)
  
    # è·å–å‹ç¼©æ–‡ä»¶è·¯å¾„
    compressed_paths = result.get('compressed_paths', [])
  
    # æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
    all_temp_files = image_paths + compressed_paths
    for temp_path in all_temp_files:
        if os.path.exists(temp_path):
            try:
                os.remove(temp_path)
                logger.info(f"åˆ é™¤ä¸´æ—¶æ–‡ä»¶: {temp_path}")
            except Exception as e:
                logger.warning(f"åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {e}")
```

**æµå¼æ¥å£**ï¼š

```python
@app.route('/api/chat_stream', methods=['POST'])
def chat_stream():
    def generate():
        # ç”¨äºæ¥æ”¶å‹ç¼©æ–‡ä»¶è·¯å¾„çš„å®¹å™¨
        compressed_paths = []
      
        try:
            # æµå¼ç”Ÿæˆï¼ˆä¼ é€’å®¹å™¨ï¼‰
            for chunk in model_manager.generate_response_stream(
                ...,
                compressed_paths_container=compressed_paths
            ):
                yield chunk
        finally:
            # æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
            all_temp_files = image_paths + compressed_paths
            logger.info(f"æ¸…ç†{len(all_temp_files)}ä¸ªä¸´æ—¶æ–‡ä»¶ï¼ˆåŸå§‹:{len(image_paths)}, å‹ç¼©:{len(compressed_paths)}ï¼‰")
            for temp_path in all_temp_files:
                if os.path.exists(temp_path):
                    os.remove(temp_path)
```

### æ•ˆæœ

- âœ… å®Œæ•´æ¸…ç†åŸå§‹æ–‡ä»¶å’Œå‹ç¼©æ–‡ä»¶
- âœ… é˜²æ­¢ä¸´æ—¶æ–‡ä»¶å †ç§¯
- âœ… èŠ‚çœç£ç›˜ç©ºé—´
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

---

## æµ‹è¯•å»ºè®®

### 1. å¹¶å‘æ§åˆ¶æµ‹è¯•

```python
# ä½¿ç”¨å¤šçº¿ç¨‹åŒæ—¶å‘é€4ä¸ªè¯·æ±‚ï¼ˆè¶…è¿‡é™åˆ¶3ä¸ªï¼‰
import threading
import requests

def send_request():
    response = requests.post('http://localhost:5000/api/chat_stream', ...)
    print(f"çŠ¶æ€ç : {response.status_code}")

threads = [threading.Thread(target=send_request) for _ in range(4)]
for t in threads:
    t.start()
for t in threads:
    t.join()

# é¢„æœŸï¼š3ä¸ªè¯·æ±‚æˆåŠŸå¤„ç†ï¼Œ1ä¸ªè¿”å›429
```

### 2. å›¾ç‰‡å‹ç¼©æµ‹è¯•

```bash
# æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤å‹ç¼©æµç¨‹
# åº”è¯¥çœ‹åˆ°ï¼š
# - "ğŸ–¼ï¸ å¼€å§‹é¢„å¤„ç†å›¾ç‰‡..."
# - "âœ… å›¾ç‰‡é¢„å¤„ç†å®Œæˆï¼Œç”Ÿæˆäº†Xä¸ªå‹ç¼©æ–‡ä»¶"
```

### 3. æ–‡ä»¶æ¸…ç†æµ‹è¯•

```bash
# ç›‘æ§uploadsç›®å½•
watch -n 1 "ls -lh web_interface/uploads/"

# å‘é€å¸¦å›¾ç‰‡çš„è¯·æ±‚åï¼Œæ£€æŸ¥ï¼š
# - åŸå§‹å›¾ç‰‡æ–‡ä»¶
# - å‹ç¼©å›¾ç‰‡æ–‡ä»¶ (*_compressed.*)
# éƒ½åº”è¯¥åœ¨è¯·æ±‚å®Œæˆåè¢«åˆ é™¤
```

---

## æ€§èƒ½æŒ‡æ ‡

### æ”¹è¿›å‰

- å¹¶å‘è¯·æ±‚ï¼šæ— é™åˆ¶ â†’ **æ˜“OOM**
- å›¾ç‰‡å‹ç¼©ï¼šä¸ä¸€è‡´ â†’ **æ˜¾å­˜æµªè´¹**
- ä¸´æ—¶æ–‡ä»¶ï¼šä»…æ¸…ç†åŸå§‹ â†’ **ç£ç›˜å †ç§¯**

### æ”¹è¿›å

- å¹¶å‘è¯·æ±‚ï¼šæœ€å¤š3ä¸ª â†’ **ç¨³å®šå¯é ** âœ…
- å›¾ç‰‡å‹ç¼©ï¼šç»Ÿä¸€å¤„ç† â†’ **æ˜¾å­˜ä¼˜åŒ–** âœ…
- ä¸´æ—¶æ–‡ä»¶ï¼šå®Œæ•´æ¸…ç† â†’ **ç£ç›˜å¹²å‡€** âœ…

---

## é…ç½®å‚æ•°

å¯ä»¥æ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

| å‚æ•°                           | ä½ç½®      | é»˜è®¤å€¼  | è¯´æ˜                 |
| ------------------------------ | --------- | ------- | -------------------- |
| `MAX_CONCURRENT_REQUESTS`    | config.py | 3       | æœ€å¤§å¹¶å‘è¯·æ±‚æ•°       |
| `IMAGE_COMPRESSION_MAX_SIZE` | config.py | 1024    | å›¾ç‰‡å‹ç¼©æœ€å¤§è¾¹é•¿     |
| `MAX_PIXELS`                 | config.py | 1003520 | æ¨¡å‹å¤„ç†çš„æœ€å¤§åƒç´ æ•° |

### è°ƒæ•´å»ºè®®

- **16GBæ˜¾å­˜**ï¼šå¯æé«˜åˆ° `MAX_CONCURRENT_REQUESTS = 5`
- **32GBæ˜¾å­˜**ï¼šå¯æé«˜åˆ° `MAX_CONCURRENT_REQUESTS = 8`
- **é«˜åˆ†è¾¨ç‡éœ€æ±‚**ï¼šæé«˜ `IMAGE_COMPRESSION_MAX_SIZE = 2048`

---

## æ€»ç»“

è¿™ä¸‰é¡¹é«˜ä¼˜å…ˆçº§æ”¹è¿›ä½¿ç³»ç»Ÿæ›´åŠ **å¥å£®ã€é«˜æ•ˆã€å¯é **ï¼š

1. âœ… **å¹¶å‘æ§åˆ¶** - é˜²æ­¢æœåŠ¡å™¨è¿‡è½½
2. âœ… **ç»Ÿä¸€å‹ç¼©** - ä¼˜åŒ–æ˜¾å­˜ä½¿ç”¨
3. âœ… **å®Œæ•´æ¸…ç†** - é¿å…ç£ç›˜å †ç§¯

æ‰€æœ‰æ”¹è¿›éƒ½éµå¾ªä¸šç•Œæœ€ä½³å®è·µï¼Œä»£ç è´¨é‡é«˜ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚
