# å¤šè½®å¯¹è¯å›¾ç‰‡è®°å¿†åŠŸèƒ½è¯´æ˜

## é—®é¢˜æè¿°

åœ¨ä¹‹å‰çš„å®ç°ä¸­ï¼Œç”¨æˆ·ä¸Šä¼ å›¾ç‰‡åï¼š
- **ç¬¬ä¸€æ¬¡æé—®**ï¼šAIèƒ½æ­£å¸¸åˆ†æå›¾ç‰‡å†…å®¹ âœ…
- **åç»­æé—®**ï¼šAIæ— æ³•çœ‹åˆ°ä¹‹å‰ä¸Šä¼ çš„å›¾ç‰‡ï¼Œæ— æ³•å›ç­”ç›¸å…³é—®é¢˜ âŒ

**é—®é¢˜åŸå› **ï¼š
1. å†å²è®°å½•åªä¿å­˜æ–‡æœ¬å¯¹è¯ï¼Œä¸åŒ…å«å›¾ç‰‡ä¿¡æ¯
2. ä¸Šä¼ çš„å›¾ç‰‡åœ¨å¤„ç†å®Œåç«‹å³åˆ é™¤
3. æ¨¡å‹åœ¨å¤„ç†åç»­å¯¹è¯æ—¶æ— æ³•è®¿é—®å†å²å›¾ç‰‡

## è§£å†³æ–¹æ¡ˆ

é‡‡ç”¨**æ–¹æ¡ˆä¸€ï¼šä¿ç•™ä¼šè¯å›¾ç‰‡å¹¶åœ¨å†å²ä¸­ä¼ é€’**

### æ ¸å¿ƒæ”¹åŠ¨

#### 1. ä¿å­˜å›¾ç‰‡è·¯å¾„åˆ°å†å²è®°å½• (`app.py`)
```python
# ä¿å­˜ç”¨æˆ·æ¶ˆæ¯æ—¶ï¼Œå¢åŠ  image_paths å­—æ®µ
user_message = {
    "role": "user",
    "content": prompt,
    "has_images": len(image_paths) > 0,
    "image_count": len(image_paths),
    "image_paths": image_paths.copy(),  # ğŸ”¥ æ–°å¢ï¼šä¿å­˜åŸå§‹å›¾ç‰‡è·¯å¾„
    "timestamp": datetime.now().isoformat()
}
```

#### 2. åªåˆ é™¤å‹ç¼©æ–‡ä»¶ï¼Œä¿ç•™åŸå§‹å›¾ç‰‡ (`app.py`)
```python
# æ¸…ç†ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶ï¼ˆåªåˆ é™¤å‹ç¼©æ–‡ä»¶ï¼Œä¿ç•™åŸå§‹å›¾ç‰‡ç”¨äºåç»­å¯¹è¯ï¼‰
for temp_path in compressed_paths:
    if os.path.exists(temp_path):
        os.remove(temp_path)

# åŸå§‹å›¾ç‰‡ä¿ç•™åœ¨ä¼šè¯ä¸­ï¼Œç­‰æ¸…ç†å†å²æ—¶ä¸€å¹¶åˆ é™¤
logger.info(f"ä¿ç•™{len(image_paths)}å¼ åŸå§‹å›¾ç‰‡ç”¨äºåç»­å¯¹è¯")
```

#### 3. ä»å†å²ä¸­æå–å¹¶ä¼ é€’å›¾ç‰‡ + å‹ç¼©å¤„ç† (`model_manager.py`)
```python
# æ·»åŠ å†å²æ¶ˆæ¯ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
for hist in history:
    role = hist.get('role')
    content = hist.get('content')
    
    if role and content:
        hist_content = [{"type": "text", "text": content}]
        
        # ğŸ”¥ å¦‚æœå†å²æ¶ˆæ¯åŒ…å«å›¾ç‰‡ï¼Œä¹Ÿæ·»åŠ è¿›å»
        if role == "user" and hist.get('has_images'):
            hist_image_paths = hist.get('image_paths', [])
            for img_path in hist_image_paths:
                if os.path.exists(img_path):
                    # âš¡ é‡è¦ï¼šå‹ç¼©å†å²å›¾ç‰‡ä»¥èŠ‚çœæ˜¾å­˜
                    processed_hist_path = self.preprocess_image(img_path, max_size=1024)
                    hist_content.insert(0, {"type": "image", "image": processed_hist_path})
                    # å¦‚æœç”Ÿæˆäº†å‹ç¼©æ–‡ä»¶ï¼Œè®°å½•ä¸‹æ¥ç”¨äºåç»­æ¸…ç†
                    if processed_hist_path != img_path:
                        compressed_paths.append(processed_hist_path)
        
        messages.append({
            "role": role,
            "content": hist_content
        })
```

#### 4. æ¸…ç†å†å²æ—¶åˆ é™¤ä¼šè¯å›¾ç‰‡ (`app.py`)
```python
# æ¸…é™¤ä¼šè¯å†å²æ—¶ï¼Œä¹Ÿæ¸…ç†ç›¸å…³çš„å›¾ç‰‡æ–‡ä»¶
for msg in conversation_sessions[session_id]:
    if msg.get('role') == 'user' and msg.get('image_paths'):
        for img_path in msg['image_paths']:
            if os.path.exists(img_path):
                os.remove(img_path)
```

## ä¿®æ”¹çš„æ–‡ä»¶

1. **`web_interface/backend/app.py`**
   - ä¿®æ”¹ `/api/chat` æ¥å£ï¼šä¿å­˜å›¾ç‰‡è·¯å¾„åˆ°å†å²ï¼Œä¿ç•™åŸå§‹å›¾ç‰‡
   - ä¿®æ”¹ `/api/chat_stream` æ¥å£ï¼šåŒæ ·çš„é€»è¾‘
   - ä¿®æ”¹ `/api/clear_history` æ¥å£ï¼šæ¸…ç†å†å²æ—¶åˆ é™¤å›¾ç‰‡æ–‡ä»¶

2. **`web_interface/backend/model_manager.py`**
   - ä¿®æ”¹ `generate_response_with_history` æ–¹æ³•ï¼šä»å†å²ä¸­æå–å›¾ç‰‡
   - ä¿®æ”¹ `generate_response_stream` æ–¹æ³•ï¼šåŒæ ·çš„é€»è¾‘

## åŠŸèƒ½æ•ˆæœ

âœ… **ç°åœ¨æ”¯æŒå¤šè½®å¯¹è¯ä¸­çš„å›¾ç‰‡è®°å¿†**ï¼š
- ç”¨æˆ·ä¸Šä¼ åŒ»ç–—æŠ¥å‘Šæˆªå›¾ï¼Œç¬¬ä¸€æ¬¡æé—®åˆ†æç—…æƒ… â†’ AIèƒ½çœ‹åˆ°å›¾ç‰‡
- ç¬¬äºŒæ¬¡æé—®"æ‚£è€…çš„å¹´é¾„æ˜¯å¤šå°‘" â†’ AIä»èƒ½çœ‹åˆ°ä¹‹å‰çš„æŠ¥å‘Šæˆªå›¾
- ç¬¬ä¸‰æ¬¡æé—®"æŠ¥å‘Šä¸­çš„æŸä¸ªæŒ‡æ ‡" â†’ AIä»èƒ½è®¿é—®æ‰€æœ‰å†å²å›¾ç‰‡

âœ… **èµ„æºç®¡ç†ä¼˜åŒ–**ï¼š
- å‹ç¼©æ–‡ä»¶ç«‹å³åˆ é™¤ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´
- åŸå§‹å›¾ç‰‡ä¿ç•™åœ¨ä¼šè¯ä¸­ï¼Œç”¨äºåç»­å¯¹è¯
- æ¸…ç†å¯¹è¯å†å²æ—¶è‡ªåŠ¨åˆ é™¤ç›¸å…³å›¾ç‰‡

âœ… **æ˜¾å­˜ç®¡ç†**ï¼š
- å†å²å›¾ç‰‡åœ¨æ¯è½®å¯¹è¯æ—¶é‡æ–°ä¼ é€’ç»™æ¨¡å‹
- é…åˆ `max_pixels` è®¾ç½®ï¼Œæ§åˆ¶æ˜¾å­˜å ç”¨
- å›¾ç‰‡ä¼šè¢«å‹ç¼©å¤„ç†ï¼Œä½†ä¸å½±å“è¯†åˆ«æ•ˆæœ

## å…³é”®ä¼˜åŒ–ï¼šå†å²å›¾ç‰‡å‹ç¼©å¤„ç†

### é—®é¢˜å‘ç°
åˆå§‹å®ç°ä¸­å­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„æ˜¾å­˜é—®é¢˜ï¼š
- âœ… **å½“å‰ä¸Šä¼ çš„å›¾ç‰‡**ï¼šä¼šè¢«å‹ç¼©åˆ° 1024px æœ€å¤§è¾¹é•¿
- âŒ **å†å²å›¾ç‰‡**ï¼šç›´æ¥ä½¿ç”¨åŸå§‹è·¯å¾„ï¼Œæœªç»å‹ç¼©å¤„ç†

è¿™å¯¼è‡´åç»­å¯¹è¯æ—¶ï¼Œå†å²å›¾ç‰‡ä»¥**åŸå§‹å¤§å°ºå¯¸**ä¼ é€’ç»™æ¨¡å‹ï¼Œå¯èƒ½å¯¼è‡´æ˜¾å­˜æº¢å‡ºï¼

### è§£å†³æ–¹æ¡ˆ
åœ¨ `model_manager.py` ä¸­ï¼Œå¯¹å†å²å›¾ç‰‡ä¹Ÿè¿›è¡Œå‹ç¼©å¤„ç†ï¼š

```python
# å¤„ç†å†å²å›¾ç‰‡æ—¶
processed_hist_path = self.preprocess_image(img_path, max_size=1024)
```

**æ•ˆæœ**ï¼š
- æ‰€æœ‰å›¾ç‰‡ï¼ˆåŒ…æ‹¬å½“å‰å’Œå†å²ï¼‰éƒ½è¢«å‹ç¼©åˆ° 1024px
- æ˜¾å­˜å ç”¨å¯æ§ï¼Œé¿å… OOM é”™è¯¯
- å‹ç¼©æ–‡ä»¶æ­£ç¡®è®°å½•å¹¶åœ¨ä½¿ç”¨åæ¸…ç†

## æ³¨æ„äº‹é¡¹

1. **ç£ç›˜ç©ºé—´**ï¼šåŸå§‹å›¾ç‰‡ä¼šä¿ç•™ç›´åˆ°æ¸…ç†å¯¹è¯å†å²ï¼Œéœ€è¦å®šæœŸæ¸…ç†
2. **æ˜¾å­˜å ç”¨**ï¼šå¤šè½®å¯¹è¯ä¼šä¼ é€’æ‰€æœ‰å†å²å›¾ç‰‡ï¼ˆå·²å‹ç¼©ï¼‰ï¼Œæ˜¾å­˜å ç”¨ä¼šå¢åŠ ä½†å¯æ§
3. **ä¼šè¯ç®¡ç†**ï¼šå»ºè®®åœ¨ä¸éœ€è¦æ—¶åŠæ—¶æ¸…ç†å¯¹è¯å†å²ï¼Œé‡Šæ”¾èµ„æº
4. **å›¾ç‰‡è´¨é‡**ï¼šå‹ç¼©åˆ° 1024px å¯¹åŒ»ç–—å½±åƒä»ä¿æŒè¶³å¤Ÿçš„è¯†åˆ«ç²¾åº¦

## ä¿®æ”¹æ—¥æœŸ

2025-11-03

