# 多轮对话图片记忆功能说明

## 📋 问题描述

在多轮对话中，AI 无法识别之前上传的图片内容。

### 复现步骤
1. 用户发送消息，包含 **文字和图片1** → AI 正常回答 ✅
2. 用户发送消息，仅包含 **文字** → AI 正常回答 ✅
3. 用户发送消息，包含 **文字和图片2** → AI 正常回答 ✅
4. 用户询问 **图片1** 中的内容 → AI 回复"无法识别" ❌

### 原因分析
1. **基础问题**：历史记录不包含图片信息，上传的图片处理完即删除
2. **上下文缺失**：模型不知道图片的顺序和来源，无法理解"图片1"的引用
3. **日志不足**：难以追踪历史图片是否被正确恢复

## ✅ 解决方案

### 第一阶段：基础图片记忆实现

#### 1. 保存图片路径到历史记录 (`app.py`)
```python
user_message = {
    "role": "user",
    "content": prompt,
    "has_images": len(image_paths) > 0,
    "image_count": len(image_paths),
    "image_paths": image_paths.copy(),  # 保存原始图片路径
    "timestamp": datetime.now().isoformat()
}
```

#### 2. 保留原始图片，只删除压缩文件 (`app.py`)
```python
# 清理压缩文件，保留原始图片用于后续对话
for temp_path in compressed_paths:
    if os.path.exists(temp_path):
        os.remove(temp_path)

logger.info(f"保留{len(image_paths)}张原始图片用于后续对话")
```

#### 3. 从历史中提取图片并压缩 (`model_manager.py`)
```python
# 历史消息包含图片时
if role == "user" and hist.get('has_images'):
    hist_image_paths = hist.get('image_paths', [])
    for img_path in hist_image_paths:
        if os.path.exists(img_path):
            # ⚡ 重要：压缩历史图片以节省显存
            processed_hist_path = self.preprocess_image(img_path, max_size=1024)
            hist_content.insert(0, {"type": "image", "image": processed_hist_path})
            if processed_hist_path != img_path:
                compressed_paths.append(processed_hist_path)
```

### 第二阶段：增强优化

#### 1. 引入图片编号系统
使用全局计数器 `total_image_counter` 给每张图片编号：

```python
# 用于给图片编号，便于后续引用
total_image_counter = 0

# 处理历史图片
for img_path in hist_image_paths:
    if os.path.exists(img_path):
        total_image_counter += 1  # 图片1, 图片2, ...
        logger.info(f"✅ 历史消息[{hist_idx}] 恢复图片 #{total_image_counter}: {img_path}")

# 处理当前图片
for image_path in image_paths:
    total_image_counter += 1
    logger.info(f"🖼️ 当前消息图片 #{total_image_counter}: {image_path}")
```

#### 2. 创建结构化提示词 (`_build_enhanced_prompt()`)

```python
def _build_enhanced_prompt(self, prompt: str, total_image_counter: int, current_image_count: int) -> str:
    """构建增强的提示词，包含图片上下文信息"""
    enhanced_prompt = prompt
    
    if total_image_counter > 0:
        history_image_count = total_image_counter - current_image_count
        
        if history_image_count > 0 and current_image_count > 0:
            # 同时有历史图片和当前图片
            context_info = [
                f"【图片上下文】本次对话共有 {total_image_counter} 张图片：",
                f"• 之前上传的图片: 第1张到第{history_image_count}张",
                f"• 本次上传的图片: 第{history_image_count+1}张到第{total_image_counter}张"
            ]
        elif history_image_count > 0:
            # 只有历史图片
            context_info = [
                f"【图片上下文】本次对话包含之前上传的 {history_image_count} 张图片"
                f"（第1张到第{history_image_count}张），请基于这些图片回答问题。"
            ]
        
        if context_info:
            enhanced_prompt = "\n".join(context_info) + "\n\n【用户问题】" + prompt
    
    return enhanced_prompt
```

**效果示例**：

修复前：
```
用户问题: 图片1中显示的是什么？
```

修复后：
```
【图片上下文】本次对话共有 2 张图片：
• 之前上传的图片: 第1张到第1张
• 本次上传的图片: 第2张到第2张

【用户问题】图片1中显示的是什么？
```

#### 3. 增强日志系统

```python
# 详细的图片恢复日志
for hist_idx, hist in enumerate(history):
    if role == "user" and hist.get('has_images'):
        recovered_count = 0
        missing_count = 0
        
        for img_path in hist_image_paths:
            if os.path.exists(img_path):
                total_image_counter += 1
                logger.info(f"✅ 历史消息[{hist_idx}] 恢复图片 #{total_image_counter}: {img_path}")
                recovered_count += 1
            else:
                missing_count += 1
                logger.warning(f"⚠️ 历史消息[{hist_idx}] 图片文件不存在: {img_path}")
        
        if recovered_count > 0:
            logger.info(f"📎 历史消息[{hist_idx}] 成功恢复 {recovered_count} 张图片")
        if missing_count > 0:
            logger.warning(f"⚠️ 历史消息[{hist_idx}] 有 {missing_count} 张图片丢失")
```

**日志示例**：
```
🤔 生成回复: 请分析一下第1张图片... (图片数: 0, 历史消息数: 4)
✅ 历史消息[0] 恢复图片 #1: uploads/image1_1234.jpg
📎 历史消息[0] 成功恢复 1 张图片
✅ 历史消息[2] 恢复图片 #2: uploads/image2_5678.jpg
📎 历史消息[2] 成功恢复 1 张图片
📝 已添加图片上下文说明 (总计2张, 历史2张, 当前0张)
📝 消息总数: 5, 图片总数: 2 (历史: 2, 当前: 0)
✅ 生成完成，长度: 156
```

## 📝 修改的文件

### 1. `web_interface/backend/app.py`
- 修改 `/api/chat` 和 `/api/chat_stream`：保存图片路径，保留原始图片
- 修改 `/api/clear_history`：清理历史时删除图片文件

### 2. `web_interface/backend/model_manager.py`
- 新增 `_build_enhanced_prompt()` 方法：构建结构化提示词
- 改进 `generate_response_with_history()` 和 `generate_response_stream()`：
  - 添加图片编号系统
  - 增强历史图片恢复日志
  - 压缩历史图片
  - 使用结构化提示词

## 🎯 功能效果

✅ **支持图片引用**：用户可以说"第1张图片"、"第2张图片"，模型能理解
✅ **显存优化**：所有图片（当前+历史）都压缩到 1024px，避免 OOM
✅ **资源管理**：压缩文件立即删除，原始图片保留直到清理对话历史
✅ **错误诊断**：图片文件丢失时有明确的警告日志

## 🧪 测试场景

1. **基本图片记忆**：上传图片A → 发送文字 → 询问"之前的图片"
2. **多图片引用**：上传图片A → 上传图片B → 询问"第1张和第2张的区别"
3. **长对话记忆**：5轮以上包含图片的对话 → 询问"最早的图片"
4. **错误处理**：删除 uploads 中的文件 → 检查日志中的警告信息

## ⚠️ 注意事项

1. **图片编号从1开始**：符合用户习惯（"第1张图片"而不是"第0张图片"）
2. **磁盘空间**：原始图片保留直到清理对话历史，需要定期清理
3. **显存占用**：多轮对话会传递所有历史图片（已压缩），显存占用会增加但可控
4. **压缩质量**：1024px 对医疗影像仍保持足够的识别精度

## 📅 修改日期

2025-11-03
