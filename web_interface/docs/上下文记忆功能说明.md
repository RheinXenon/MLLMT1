# 对话上下文记忆功能说明

## 更新概述

已为 Lingshu-7B Web 界面添加了对话上下文记忆功能，现在系统能够记住之前的对话内容，实现更自然的多轮对话交互。

## 功能特性

### 1. 自动会话管理
- **自动创建会话ID**：首次对话时系统自动创建唯一会话ID
- **持久化会话**：会话ID在对话期间保持不变
- **服务器端存储**：对话历史存储在服务器端，确保数据一致性

### 2. 智能上下文理解
- **多轮对话**：模型能够理解之前的对话内容
- **上下文延续**：可以基于前面的对话进行追问
- **历史记录传递**：每次请求都会将历史对话发送给模型

### 3. 对话历史管理
- **清空功能增强**：点击"清空对话"按钮会同时清除前端显示和服务器端历史
- **会话重置**：清空后会创建新的会话ID，开始新的对话

## 代码变更详情

### 后端修改

#### 1. `web_interface/backend/app.py`
- 添加会话管理功能
  - 使用 `conversation_sessions` 字典存储所有会话的历史记录
  - 为每个会话分配唯一的 UUID
- 修改 `/api/chat` 端点
  - 接收和管理 `session_id` 参数
  - 保存用户消息和助手回复到历史记录
  - 返回 `session_id` 给前端
- 新增 `/api/clear_history` 端点
  - 支持清除特定会话或所有会话的历史记录

#### 2. `web_interface/backend/model_manager.py`
- 保留原有 `generate_response()` 方法（向后兼容）
- 新增 `generate_response_with_history()` 方法
  - 接收对话历史参数
  - 将历史对话和当前问题一起发送给模型
  - 构建完整的多轮对话消息列表

### 前端修改

#### 3. `web_interface/frontend/static/js/api.js`
- 修改 `chat()` 方法
  - 添加 `sessionId` 参数
  - 将会话ID发送到后端
- 新增 `clearHistory()` 方法
  - 调用后端清除历史记录的 API

#### 4. `web_interface/frontend/static/js/main.js`
- 在 `appState` 中添加 `sessionId` 字段
- 修改 `handleSendMessage()`
  - 发送请求时包含会话ID
  - 保存后端返回的会话ID
- 修改 `handleClearChat()`
  - 清空对话时调用后端API清除历史
  - 重置会话ID

## 使用示例

### 示例对话 1：连续提问
```
用户：什么是高血压？
助手：高血压是指血压持续高于正常值的状态...

用户：它有哪些症状？
助手：高血压的常见症状包括...  [✓ 理解"它"指代高血压]

用户：如何预防？
助手：预防高血压的方法有...  [✓ 延续高血压话题]
```

### 示例对话 2：图片分析延续
```
用户：[上传胸部X光片] 请分析这张图片
助手：从这张胸部X光片可以看到...

用户：那应该进行什么检查？
助手：基于前面看到的影像...  [✓ 记得之前讨论的X光片]
```

## 技术细节

### 会话存储结构
```python
conversation_sessions = {
    "session_id_xxx": [
        {
            "role": "user",
            "content": "用户消息",
            "has_image": False,
            "timestamp": "2024-11-02T10:30:00"
        },
        {
            "role": "assistant",
            "content": "助手回复",
            "timestamp": "2024-11-02T10:30:05"
        }
    ]
}
```

### 消息流程
1. 用户在前端输入问题
2. 前端发送：`prompt + image + config + session_id`
3. 后端查找/创建会话历史
4. 后端将历史+当前问题传给模型
5. 模型生成回复（理解上下文）
6. 后端保存对话到历史
7. 前端接收并显示回复

### 性能考虑
- **内存管理**：历史记录存储在服务器内存中
- **上下文长度**：随着对话增多，可能影响生成速度
- **建议**：长对话后可以点击"清空对话"重置上下文

## 注意事项

1. **服务器重启**：服务器重启后会丢失所有会话历史（内存存储）
2. **内存占用**：长时间运行可能积累大量会话数据
3. **上下文限制**：模型有最大上下文长度限制，超长对话可能被截断
4. **图片处理**：历史记录中不重复发送图片，只保留文本

## 未来改进方向

1. **持久化存储**：将会话历史保存到数据库
2. **会话过期**：自动清理长时间未使用的会话
3. **历史长度限制**：只保留最近N轮对话
4. **会话管理界面**：显示当前会话状态和历史统计
5. **导出对话**：支持导出对话记录

## 测试建议

### 基础测试
1. 发送第一条消息，检查是否创建会话
2. 发送第二条消息，检查是否理解上下文
3. 点击"清空对话"，检查是否重置会话

### 进阶测试
1. 测试多轮对话的上下文理解能力
2. 测试图片+文字的上下文延续
3. 测试长对话的表现和性能
4. 测试清空后新对话的独立性

## 更新日期
2024年11月2日

